{"componentChunkName":"component---src-templates-markdown-js","path":"/operators/continuous-deployment/docs/admin/add_new_cluster_spec.md","result":{"data":{"site":{"siteMetadata":{"title":"Operate First"}},"markdownRemark":{"id":"c1da670e-9526-5448-9cdf-7e5cd94ad015","html":"<h1 id=\"adding-a-new-cluster-spec\" style=\"position:relative;\"><a href=\"#adding-a-new-cluster-spec\" aria-label=\"adding a new cluster spec permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Adding a new cluster spec</h1>\n<h2 id=\"prerequisites\" style=\"position:relative;\"><a href=\"#prerequisites\" aria-label=\"prerequisites permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Prerequisites</h2>\n<ul class=\"pf-c-list\">\n<li>sops 3.6+</li>\n<li>sops access</li>\n</ul>\n<h2 id=\"instructions\" style=\"position:relative;\"><a href=\"#instructions\" aria-label=\"instructions permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Instructions</h2>\n<p>ArgoCD will need a service account present on the cluster for deployments. Where the SA is located is irrelevant, though it’s advised to have it be located in its own independent namespace. For consistency name this service account <code class=\"language-text\">argocd-manager</code>.</p>\n<p>This workflow may look like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">oc login <span class=\"token operator\">&lt;</span>your_cluster<span class=\"token operator\">></span>\noc new-project argocd-manager\noc create sa argocd-manager</code></pre></div>\n<p>Get the token for this SA</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token assign-left variable\">SA_TOKEN</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">`</span>oc sa get-token argocd-manager -n argocd-manager<span class=\"token variable\">`</span></span></code></pre></div>\n<p>Store the cluster specs in <code class=\"language-text\">/manifests/overlays/&lt;env&gt;/secrets/clusters</code> folder.</p>\n<p>Create the cluster spec:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token comment\"># /manifests/overlays/dev/secrets/clusters/dev.cluster.example.yaml</span>\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Secret\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> dev<span class=\"token punctuation\">-</span>cluster<span class=\"token punctuation\">-</span>spec\n    <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">argocd.argoproj.io/secret-type</span><span class=\"token punctuation\">:</span> cluster\n    <span class=\"token key atrule\">annotations</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">managed-by</span><span class=\"token punctuation\">:</span> argocd.argoproj.io\n<span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> Opaque\n<span class=\"token key atrule\">stringData</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span>  dev.cluster.com\n    <span class=\"token key atrule\">config</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n        {\"bearerToken\": ${SA_TOKEN}, \"tlsClientConfig\": {\"insecure\": true}}</span>\n    <span class=\"token key atrule\">namespaces</span><span class=\"token punctuation\">:</span> namespace_1<span class=\"token punctuation\">,</span>namespace_2\n    <span class=\"token key atrule\">server</span><span class=\"token punctuation\">:</span> https<span class=\"token punctuation\">:</span>//dev.cluster.uri.com<span class=\"token punctuation\">:</span><span class=\"token number\">44</span></code></pre></div>\n<p>Let’s go over what some of the fields in the <code class=\"language-text\">stringData</code> field refer to:</p>\n<ul class=\"pf-c-list\">\n<li><code class=\"language-text\">name</code>: Name for this cluster, appears in the ArgoCD UI</li>\n<li><code class=\"language-text\">config</code>: The token goes here, replace the contents of ${SA_TOKEN} with the one retrieved earlier.</li>\n<li><code class=\"language-text\">namespace</code>: List of namespaces ArgoCD has permissions to deploy to, comma-separated, no whitespace</li>\n<li><code class=\"language-text\">server</code>: Cluster api server hostname, can be retrieved by running <code class=\"language-text\">oc whoami --show-server</code></li>\n</ul>\n<p>SOPS encrypt the manifest and store it in the <code class=\"language-text\">clusters</code> directory.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ target_env=dev\n$ cd manifests/overlays/$target_env/secrets/clusters\n$ sops -e dev.cluster.example.yaml &gt; dev.cluster.example.enc.yaml\n# Delete the cluster_spec.yaml (decrypted version)\n$ rm dev.cluster.example.yaml</code></pre></div>\n<blockquote>\n<p>Note: DO NOT submit a PR with the decrypted cluster spec secret.</p>\n</blockquote>","fields":{"srcLink":"https://github.com/operate-first/continuous-deployment/blob/master/docs/admin/add_new_cluster_spec.md"},"frontmatter":{"title":"","description":null}}},"pageContext":{"id":"c1da670e-9526-5448-9cdf-7e5cd94ad015"}},"staticQueryHashes":["117426894","3000541721"]}