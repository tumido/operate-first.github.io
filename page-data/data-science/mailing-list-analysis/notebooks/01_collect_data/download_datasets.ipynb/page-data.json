{"componentChunkName":"component---src-templates-jupyter-notebook-js","path":"/data-science/mailing-list-analysis/notebooks/01_collect_data/download_datasets.ipynb","result":{"data":{"site":{"siteMetadata":{"title":"Operate First"}},"jupyterNotebook":{"id":"fd3822ef-36d4-5ded-a01f-3474aafdf65b >>> JupyterNotebook","html":"<div class=\"notebook-render\"><div class=\"sc-ifAKCX zMCZx\"><div class=\"sc-bxivhb HLmih cell\" style=\"box-shadow:none\"><div class=\"sc-iwsKbI exQuEV markdown\"><h1>Download Datasets</h1>\n<p><strong>NOTE: This notebook is only used in automation</strong></p>\n<p>While running our application on a monthly basis, we would prefer to not re-run all of the data preprocessing each month. Instead, we only pre-process the data once; on the month that it is pulled, and then store the interim data set in ceph. This notebook is responsible for downloading the pre-processed data sets stored remotely into our application for use by the analysis notebooks.   </p></div></div><div class=\"sc-bxivhb HLmih cell\" style=\"box-shadow:none\"><div class=\"sc-gzVnrw iiEGBE input-container\"><div class=\"sc-bwzfXH jsVRSS prompt\">[ ]</div><pre class=\"sc-bZQynM dQAqiJ input\" style=\"color:#393A34;font-family:&quot;Consolas&quot;, &quot;Bitstream Vera Sans Mono&quot;, &quot;Courier New&quot;, Courier, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;font-size:0.95em;line-height:1.2em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:10px 0px 10px 10px;margin:0px;overflow:auto;border:none;background-color:var(--cm-background, #fafafa)\"><code style=\"color:#393A34;font-family:&quot;Consolas&quot;, &quot;Bitstream Vera Sans Mono&quot;, &quot;Courier New&quot;, Courier, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;font-size:0.95em;line-height:1.2em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none\"><span class=\"token\" style=\"color:#0000ff\">import</span> os\n<span class=\"token\" style=\"color:#0000ff\">from</span> pathlib <span class=\"token\" style=\"color:#0000ff\">import</span> Path\n<span class=\"token\" style=\"color:#0000ff\">import</span> boto3\n<span class=\"token\" style=\"color:#0000ff\">from</span> concurrent <span class=\"token\" style=\"color:#0000ff\">import</span> futures\n<span class=\"token\" style=\"color:#0000ff\">from</span> dotenv <span class=\"token\" style=\"color:#0000ff\">import</span> load_dotenv\n\nload_dotenv<span class=\"token\" style=\"color:#393A34\">(</span><span class=\"token\" style=\"color:#A31515\">&quot;../../.env&quot;</span><span class=\"token\" style=\"color:#393A34\">)</span></code></pre></div></div><div class=\"sc-bxivhb HLmih cell\" style=\"box-shadow:none\"><div class=\"sc-gzVnrw iiEGBE input-container\"><div class=\"sc-bwzfXH jsVRSS prompt\">[ ]</div><pre class=\"sc-bZQynM dQAqiJ input\" style=\"color:#393A34;font-family:&quot;Consolas&quot;, &quot;Bitstream Vera Sans Mono&quot;, &quot;Courier New&quot;, Courier, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;font-size:0.95em;line-height:1.2em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:10px 0px 10px 10px;margin:0px;overflow:auto;border:none;background-color:var(--cm-background, #fafafa)\"><code style=\"color:#393A34;font-family:&quot;Consolas&quot;, &quot;Bitstream Vera Sans Mono&quot;, &quot;Courier New&quot;, Courier, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;font-size:0.95em;line-height:1.2em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none\"><span class=\"token\" style=\"color:#008000;font-style:italic\"># Get environment variables for data access and management</span>\n\nBASE_PATH <span class=\"token\" style=\"color:#393A34\">=</span> os<span class=\"token\" style=\"color:#393A34\">.</span>getenv<span class=\"token\" style=\"color:#393A34\">(</span><span class=\"token\" style=\"color:#A31515\">&quot;LOCAL_DATA_PATH&quot;</span><span class=\"token\" style=\"color:#393A34\">,</span> <span class=\"token\" style=\"color:#A31515\">&quot;../../data&quot;</span><span class=\"token\" style=\"color:#393A34\">)</span>\nS3_ENDPOINT_URL <span class=\"token\" style=\"color:#393A34\">=</span> os<span class=\"token\" style=\"color:#393A34\">.</span>getenv<span class=\"token\" style=\"color:#393A34\">(</span><span class=\"token\" style=\"color:#A31515\">&quot;S3_ENDPOINT_URL&quot;</span><span class=\"token\" style=\"color:#393A34\">,</span> <span class=\"token\" style=\"color:#A31515\">&quot;https://s3.upshift.redhat.com&quot;</span><span class=\"token\" style=\"color:#393A34\">)</span>\nAWS_ACCESS_KEY_ID <span class=\"token\" style=\"color:#393A34\">=</span> os<span class=\"token\" style=\"color:#393A34\">.</span>getenv<span class=\"token\" style=\"color:#393A34\">(</span><span class=\"token\" style=\"color:#A31515\">&quot;AWS_ACCESS_KEY_ID&quot;</span><span class=\"token\" style=\"color:#393A34\">)</span>\nAWS_SECRET_ACCESS_KEY <span class=\"token\" style=\"color:#393A34\">=</span> os<span class=\"token\" style=\"color:#393A34\">.</span>getenv<span class=\"token\" style=\"color:#393A34\">(</span><span class=\"token\" style=\"color:#A31515\">&quot;AWS_SECRET_ACCESS_KEY&quot;</span><span class=\"token\" style=\"color:#393A34\">)</span>\nS3_BUCKET <span class=\"token\" style=\"color:#393A34\">=</span> os<span class=\"token\" style=\"color:#393A34\">.</span>getenv<span class=\"token\" style=\"color:#393A34\">(</span><span class=\"token\" style=\"color:#A31515\">&quot;S3_BUCKET&quot;</span><span class=\"token\" style=\"color:#393A34\">,</span> <span class=\"token\" style=\"color:#A31515\">&quot;DH-PLAYPEN&quot;</span><span class=\"token\" style=\"color:#393A34\">)</span>\nS3_PROJECT_KEY <span class=\"token\" style=\"color:#393A34\">=</span> os<span class=\"token\" style=\"color:#393A34\">.</span>getenv<span class=\"token\" style=\"color:#393A34\">(</span><span class=\"token\" style=\"color:#A31515\">&quot;S3_PROJECT_KEY&quot;</span><span class=\"token\" style=\"color:#393A34\">,</span> <span class=\"token\" style=\"color:#A31515\">&quot;mcliffor/fedora_devel_mail&quot;</span><span class=\"token\" style=\"color:#393A34\">)</span></code></pre></div></div><div class=\"sc-bxivhb HLmih cell\" style=\"box-shadow:none\"><div class=\"sc-gzVnrw iiEGBE input-container\"><div class=\"sc-bwzfXH jsVRSS prompt\">[ ]</div><pre class=\"sc-bZQynM dQAqiJ input\" style=\"color:#393A34;font-family:&quot;Consolas&quot;, &quot;Bitstream Vera Sans Mono&quot;, &quot;Courier New&quot;, Courier, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;font-size:0.95em;line-height:1.2em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:10px 0px 10px 10px;margin:0px;overflow:auto;border:none;background-color:var(--cm-background, #fafafa)\"><code style=\"color:#393A34;font-family:&quot;Consolas&quot;, &quot;Bitstream Vera Sans Mono&quot;, &quot;Courier New&quot;, Courier, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;font-size:0.95em;line-height:1.2em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none\"><span class=\"token\" style=\"color:#008000;font-style:italic\"># Connect to our S3 instance</span>\n\ns3 <span class=\"token\" style=\"color:#393A34\">=</span> boto3<span class=\"token\" style=\"color:#393A34\">.</span>client<span class=\"token\" style=\"color:#393A34\">(</span>\n    <span class=\"token\" style=\"color:#A31515\">&quot;s3&quot;</span><span class=\"token\" style=\"color:#393A34\">,</span>\n    endpoint_url<span class=\"token\" style=\"color:#393A34\">=</span>S3_ENDPOINT_URL<span class=\"token\" style=\"color:#393A34\">,</span>\n    aws_access_key_id<span class=\"token\" style=\"color:#393A34\">=</span>AWS_ACCESS_KEY_ID<span class=\"token\" style=\"color:#393A34\">,</span>\n    aws_secret_access_key<span class=\"token\" style=\"color:#393A34\">=</span>AWS_SECRET_ACCESS_KEY<span class=\"token\" style=\"color:#393A34\">,</span>\n<span class=\"token\" style=\"color:#393A34\">)</span></code></pre></div></div><div class=\"sc-bxivhb HLmih cell\" style=\"box-shadow:none\"><div class=\"sc-gzVnrw iiEGBE input-container\"><div class=\"sc-bwzfXH jsVRSS prompt\">[ ]</div><pre class=\"sc-bZQynM dQAqiJ input\" style=\"color:#393A34;font-family:&quot;Consolas&quot;, &quot;Bitstream Vera Sans Mono&quot;, &quot;Courier New&quot;, Courier, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;font-size:0.95em;line-height:1.2em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:10px 0px 10px 10px;margin:0px;overflow:auto;border:none;background-color:var(--cm-background, #fafafa)\"><code style=\"color:#393A34;font-family:&quot;Consolas&quot;, &quot;Bitstream Vera Sans Mono&quot;, &quot;Courier New&quot;, Courier, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;font-size:0.95em;line-height:1.2em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none\"><span class=\"token\" style=\"color:#008000;font-style:italic\"># Define a function for collecting one of the &quot;interim&quot; datasets</span>\n\n\n<span class=\"token\" style=\"color:#0000ff\">def</span> <span class=\"token\" style=\"color:#393A34\">download_dataset</span><span class=\"token\" style=\"color:#393A34\">(</span>dataset<span class=\"token\" style=\"color:#393A34\">)</span><span class=\"token\" style=\"color:#393A34\">:</span>\n    dataset_base_path <span class=\"token\" style=\"color:#393A34\">=</span> Path<span class=\"token\" style=\"color:#393A34\">(</span><span class=\"token string-interpolation\"><span class=\"token\" style=\"color:#A31515\">f&quot;</span><span class=\"token interpolation\"><span class=\"token\" style=\"color:#393A34\">{</span>BASE_PATH<span class=\"token\" style=\"color:#393A34\">}</span></span><span class=\"token\" style=\"color:#A31515\">/interim/</span><span class=\"token interpolation\"><span class=\"token\" style=\"color:#393A34\">{</span>dataset<span class=\"token\" style=\"color:#393A34\">}</span></span><span class=\"token\" style=\"color:#A31515\">&quot;</span></span><span class=\"token\" style=\"color:#393A34\">)</span>\n    dataset_base_path<span class=\"token\" style=\"color:#393A34\">.</span>mkdir<span class=\"token\" style=\"color:#393A34\">(</span>parents<span class=\"token\" style=\"color:#393A34\">=</span><span class=\"token\" style=\"color:#36acaa\">True</span><span class=\"token\" style=\"color:#393A34\">,</span> exist_ok<span class=\"token\" style=\"color:#393A34\">=</span><span class=\"token\" style=\"color:#36acaa\">True</span><span class=\"token\" style=\"color:#393A34\">)</span>\n\n    <span class=\"token\" style=\"color:#0000ff\">for</span> chunk <span class=\"token\" style=\"color:#0000ff\">in</span> s3<span class=\"token\" style=\"color:#393A34\">.</span>list_objects_v2<span class=\"token\" style=\"color:#393A34\">(</span>\n        Bucket<span class=\"token\" style=\"color:#393A34\">=</span>S3_BUCKET<span class=\"token\" style=\"color:#393A34\">,</span> Prefix<span class=\"token\" style=\"color:#393A34\">=</span><span class=\"token string-interpolation\"><span class=\"token\" style=\"color:#A31515\">f&quot;</span><span class=\"token interpolation\"><span class=\"token\" style=\"color:#393A34\">{</span>S3_PROJECT_KEY<span class=\"token\" style=\"color:#393A34\">}</span></span><span class=\"token\" style=\"color:#A31515\">/interim/</span><span class=\"token interpolation\"><span class=\"token\" style=\"color:#393A34\">{</span>dataset<span class=\"token\" style=\"color:#393A34\">}</span></span><span class=\"token\" style=\"color:#A31515\">&quot;</span></span>\n    <span class=\"token\" style=\"color:#393A34\">)</span><span class=\"token\" style=\"color:#393A34\">.</span>get<span class=\"token\" style=\"color:#393A34\">(</span><span class=\"token\" style=\"color:#A31515\">&quot;Contents&quot;</span><span class=\"token\" style=\"color:#393A34\">,</span> <span class=\"token\" style=\"color:#393A34\">(</span><span class=\"token\" style=\"color:#393A34\">)</span><span class=\"token\" style=\"color:#393A34\">)</span><span class=\"token\" style=\"color:#393A34\">:</span>\n        <span class=\"token\" style=\"color:#0000ff\">print</span><span class=\"token\" style=\"color:#393A34\">(</span>\n            <span class=\"token string-interpolation\"><span class=\"token\" style=\"color:#A31515\">f&quot;Downloading file: </span><span class=\"token interpolation\"><span class=\"token\" style=\"color:#393A34\">{</span>chunk<span class=\"token\" style=\"color:#393A34\">[</span><span class=\"token\" style=\"color:#A31515\">&#x27;Key&#x27;</span><span class=\"token\" style=\"color:#393A34\">]</span><span class=\"token\" style=\"color:#393A34\">}</span></span><span class=\"token\" style=\"color:#A31515\"> to </span><span class=\"token interpolation\"><span class=\"token\" style=\"color:#393A34\">{</span>dataset_base_path<span class=\"token\" style=\"color:#393A34\">}</span></span><span class=\"token\" style=\"color:#A31515\">/</span><span class=\"token interpolation\"><span class=\"token\" style=\"color:#393A34\">{</span>Path<span class=\"token\" style=\"color:#393A34\">(</span>chunk<span class=\"token\" style=\"color:#393A34\">[</span><span class=\"token\" style=\"color:#A31515\">&#x27;Key&#x27;</span><span class=\"token\" style=\"color:#393A34\">]</span><span class=\"token\" style=\"color:#393A34\">)</span><span class=\"token\" style=\"color:#393A34\">.</span>name<span class=\"token\" style=\"color:#393A34\">}</span></span><span class=\"token\" style=\"color:#A31515\">&quot;</span></span>\n        <span class=\"token\" style=\"color:#393A34\">)</span>\n        <span class=\"token\" style=\"color:#0000ff\">yield</span> <span class=\"token\" style=\"color:#393A34\">(</span>\n            s3<span class=\"token\" style=\"color:#393A34\">.</span>download_file<span class=\"token\" style=\"color:#393A34\">,</span>\n            S3_BUCKET<span class=\"token\" style=\"color:#393A34\">,</span>\n            chunk<span class=\"token\" style=\"color:#393A34\">[</span><span class=\"token\" style=\"color:#A31515\">&quot;Key&quot;</span><span class=\"token\" style=\"color:#393A34\">]</span><span class=\"token\" style=\"color:#393A34\">,</span>\n            <span class=\"token string-interpolation\"><span class=\"token\" style=\"color:#A31515\">f&quot;</span><span class=\"token interpolation\"><span class=\"token\" style=\"color:#393A34\">{</span>dataset_base_path<span class=\"token\" style=\"color:#393A34\">}</span></span><span class=\"token\" style=\"color:#A31515\">/</span><span class=\"token interpolation\"><span class=\"token\" style=\"color:#393A34\">{</span>Path<span class=\"token\" style=\"color:#393A34\">(</span>chunk<span class=\"token\" style=\"color:#393A34\">[</span><span class=\"token\" style=\"color:#A31515\">&#x27;Key&#x27;</span><span class=\"token\" style=\"color:#393A34\">]</span><span class=\"token\" style=\"color:#393A34\">)</span><span class=\"token\" style=\"color:#393A34\">.</span>name<span class=\"token\" style=\"color:#393A34\">}</span></span><span class=\"token\" style=\"color:#A31515\">&quot;</span></span><span class=\"token\" style=\"color:#393A34\">,</span>\n        <span class=\"token\" style=\"color:#393A34\">)</span></code></pre></div></div><div class=\"sc-bxivhb HLmih cell\" style=\"box-shadow:none\"><div class=\"sc-gzVnrw iiEGBE input-container\"><div class=\"sc-bwzfXH jsVRSS prompt\">[ ]</div><pre class=\"sc-bZQynM dQAqiJ input\" style=\"color:#393A34;font-family:&quot;Consolas&quot;, &quot;Bitstream Vera Sans Mono&quot;, &quot;Courier New&quot;, Courier, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;font-size:0.95em;line-height:1.2em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:10px 0px 10px 10px;margin:0px;overflow:auto;border:none;background-color:var(--cm-background, #fafafa)\"><code style=\"color:#393A34;font-family:&quot;Consolas&quot;, &quot;Bitstream Vera Sans Mono&quot;, &quot;Courier New&quot;, Courier, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;font-size:0.95em;line-height:1.2em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none\"><span class=\"token\" style=\"color:#008000;font-style:italic\"># Use `download_dataset` to get all DATASETS into our application.</span>\n\nDATASETS <span class=\"token\" style=\"color:#393A34\">=</span> <span class=\"token\" style=\"color:#393A34\">(</span><span class=\"token\" style=\"color:#A31515\">&quot;text&quot;</span><span class=\"token\" style=\"color:#393A34\">,</span> <span class=\"token\" style=\"color:#A31515\">&quot;metadata&quot;</span><span class=\"token\" style=\"color:#393A34\">)</span>\n\n\n<span class=\"token\" style=\"color:#0000ff\">with</span> futures<span class=\"token\" style=\"color:#393A34\">.</span>ThreadPoolExecutor<span class=\"token\" style=\"color:#393A34\">(</span>max_workers<span class=\"token\" style=\"color:#393A34\">=</span><span class=\"token\" style=\"color:#36acaa\">20</span><span class=\"token\" style=\"color:#393A34\">)</span> <span class=\"token\" style=\"color:#0000ff\">as</span> e<span class=\"token\" style=\"color:#393A34\">:</span>\n    <span class=\"token\" style=\"color:#393A34\">[</span>\n        e<span class=\"token\" style=\"color:#393A34\">.</span>submit<span class=\"token\" style=\"color:#393A34\">(</span><span class=\"token\" style=\"color:#393A34\">*</span>task<span class=\"token\" style=\"color:#393A34\">)</span>\n        <span class=\"token\" style=\"color:#0000ff\">for</span> dataset <span class=\"token\" style=\"color:#0000ff\">in</span> DATASETS\n        <span class=\"token\" style=\"color:#0000ff\">for</span> task <span class=\"token\" style=\"color:#0000ff\">in</span> download_dataset<span class=\"token\" style=\"color:#393A34\">(</span>dataset<span class=\"token\" style=\"color:#393A34\">)</span>\n    <span class=\"token\" style=\"color:#393A34\">]</span>\n\n<span class=\"token\" style=\"color:#0000ff\">print</span><span class=\"token\" style=\"color:#393A34\">(</span><span class=\"token\" style=\"color:#A31515\">&quot;Done&quot;</span><span class=\"token\" style=\"color:#393A34\">)</span></code></pre></div></div></div></div>","fields":{"srcLink":"https://github.com/aicoe-aiops/mailing-list-analysis-toolkit/blob/master/notebooks/01_collect_data/download_datasets.ipynb"}}},"pageContext":{"id":"fd3822ef-36d4-5ded-a01f-3474aafdf65b >>> JupyterNotebook"}},"staticQueryHashes":["117426894","3000541721"]}