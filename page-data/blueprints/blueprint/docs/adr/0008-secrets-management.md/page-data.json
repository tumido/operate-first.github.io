{"componentChunkName":"component---src-templates-markdown-js","path":"/blueprints/blueprint/docs/adr/0008-secrets-management.md","result":{"data":{"site":{"siteMetadata":{"title":"Operate First"}},"markdownRemark":{"id":"07ba14db-9250-58f7-827c-0980a771dd1d","html":"<h1 id=\"gitops-and-secrets-management\" style=\"position:relative;\"><a href=\"#gitops-and-secrets-management\" aria-label=\"gitops and secrets management permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>GitOPS and Secrets Management</h1>\n<ul class=\"pf-c-list\">\n<li>Status: accepted</li>\n<li>Deciders: HumairAK, hemajv, 4n4nd, anishasthana, tumido, mhild</li>\n</ul>\n<p>Technical Story: <a href=\"https://github.com/open-infrastructure-labs/ops-issues/issues/3\">issue-1</a>, <a href=\"https://github.com/operate-first/apps/issues/77\">issue-2</a></p>\n<h2 id=\"context-and-problem-statement\" style=\"position:relative;\"><a href=\"#context-and-problem-statement\" aria-label=\"context and problem statement permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Context and Problem Statement</h2>\n<p>Following a GitOps operating model requires us to describe our running system in Git. Since we operate on OpenShift/K8s, we can do this easily by specifying our entire system via <code class=\"language-text\">yaml</code> manifests and storing them in GitHub. Things get a bit more complicated when trying to reconcile where to store confidential information like <code class=\"language-text\">secrets</code>. We use the word <code class=\"language-text\">secrets</code> here a bit loosely to capture all confidential manifests (e.g. k8s secrets, routes with certs, etc.).</p>\n<p>Obviously we cannot store our <code class=\"language-text\">secrets</code> in Git in plaintext, we would like to store them in some encrypted fashion, ideally alongside the other system manifests. Other considerations are as follows:</p>\n<ul class=\"pf-c-list\">\n<li>There should be freedom to store/organize the <code class=\"language-text\">secrets</code> in any repo, path, and location.</li>\n<li>Encrypted manifests should be compatible with Kustomize.</li>\n<li>Ideally only the specific portions within manifests that are confidential will be encrypted (e.g. specific fields).</li>\n<li>ArgoCD should be able to decrypt these secrets and thus deploy them.</li>\n<li>Other teams can easily encrypt their manifests whilst maintaining ease of consumption by ArgoCD.</li>\n<li>Decryption capabilities are limited to code-owners, operate-first admins, and ArgoCD.</li>\n</ul>\n<h2 id=\"considered-options\" style=\"position:relative;\"><a href=\"#considered-options\" aria-label=\"considered options permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Considered Options</h2>\n<p>There exist many different solutions to tackle GitOps with secret management. ArgoCD has a list of recommended tools one can leverage, you may find it <a href=\"https://argoproj.github.io/argo-cd/operator-manual/secret-management/\">here</a>. We considered the following tools:</p>\n<ol class=\"pf-c-list\">\n<li><a href=\"https://github.com/bitnami-labs/sealed-secrets\">Sealed Secrets</a> - An operator that can decrypt a secret from a custom resource, this resource is stored in Git.</li>\n<li><a href=\"https://www.vaultproject.io/\">Hashicorp Vault</a> - A server with a backing storage where secrets are stored.</li>\n<li><a href=\"https://github.com/viaduct-ai/kustomize-sops#argo-cd-integration\">KSOPS</a> - A Kustomize plugin that uses <a href=\"https://github.com/mozilla/sops\">sops</a> to encrypt, the plugin itself adds a decryption generator step to the Kustomize build.</li>\n<li>Store secrets in a private/internal repo.</li>\n</ol>\n<h2 id=\"decision-outcome\" style=\"position:relative;\"><a href=\"#decision-outcome\" aria-label=\"decision outcome permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Decision Outcome</h2>\n<p>Chosen Option <code class=\"language-text\">(3)</code>. Reasons are summarized as follows:</p>\n<ul class=\"pf-c-list\">\n<li><code class=\"language-text\">Sealed Secrets</code> only allow you to encrypt k8s <code class=\"language-text\">secrets</code></li>\n<li><code class=\"language-text\">Hashicorp Vault</code> a bit too heavy duty for our use case, steep learning curve. Secrets are also stored in a backend storage and not in Git</li>\n<li>We would like to avoid storing manifests in private/internal repos. This is to stay in line with keeping our system’s desired state as public as possible.</li>\n</ul>\n<p>By using KSOPS we can encrypt specific portions of a manifest that are confidential whilst keeping the rest of the non-confidential information visible. Encrypted manifests can be stored in whichever location as needed. By using an ArgoCD image that has KSOPS installed, we can have ArgoCD also decrypt these manifests.</p>\n<p>SOPS allows you to use various methods to encrypt your manifests, we opt to use GPG as it’s free to generate and use (other methods include using AWS KMS, GCP KMS, and Azure Key Vault).</p>\n<p>We will create a GPG key that we will use to encrypt all our manifests in Git. The secret key will be made available to ArgoCD and other operate-first admins. We offer the public key to other teams should they wish to encrypt their contents and store them in Git. Doing so will allow ArgoCD to decrypt and deploy their manifests. This means that other teams will be able to encrypt, but not decrypt, their manifests in Git. To get around this, SOPS allows you to encrypt the same files with multiple keys, allowing teams to encrypt a file using our Operate-First public key (where they do not have access to the private key) and their own key (for which they also have the private key). This will allow ArgoCD to decrypt their manifests, whilst also allowing teams to retain the ability to decrypt their manifests.</p>\n<h3 id=\"positive-consequences\" style=\"position:relative;\"><a href=\"#positive-consequences\" aria-label=\"positive consequences permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Positive Consequences</h3>\n<ul class=\"pf-c-list\">\n<li>Can store secrets in Git alongside other manifests.</li>\n<li>Compatible with Kustomize.</li>\n<li>SOPS allows us to configure specific confidential fields we want encrypted inside manifests, while keeping other information public.</li>\n<li>ArgoCD can decrypt manifests.</li>\n<li>GPG key access, and SOPS configurations allow us to control who has encryption/decryption capabilities.</li>\n</ul>\n<h3 id=\"negative-consequences\" style=\"position:relative;\"><a href=\"#negative-consequences\" aria-label=\"negative consequences permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Negative Consequences</h3>\n<ul class=\"pf-c-list\">\n<li>By using GPG the cost of changing a key becomes expensive. For example, if a key is compromised, we need to update all <code class=\"language-text\">.sops.yaml</code> wherever that key is used and re-encrypt.</li>\n<li>KSOPS is a Kustomize plugin, and thus requires the <code class=\"language-text\">--enable_alpha_plugins</code>, this gives the impression that Kustomize plugins may be deprecated. However based on <a href=\"https://github.com/kubernetes-sigs/kustomize/issues/1504\">this issue</a>, it seems the real purpose is to just <code class=\"language-text\">warn the user against accidentally running 3rd party plugins.</code></li>\n<li>ArgoCD requires a custom image that includes the KSOPS tooling.</li>\n</ul>","fields":{"srcLink":"https://github.com/operate-first/blueprint/blob/master/docs/adr/0008-secrets-management.md"},"frontmatter":{"title":"","description":null}}},"pageContext":{"id":"07ba14db-9250-58f7-827c-0980a771dd1d"}},"staticQueryHashes":["117426894","3000541721"]}